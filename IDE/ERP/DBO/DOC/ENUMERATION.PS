{$DEFINE PEAKTOP:IDE/ERP/DBO/DOC/ENUMERATION.PS}
{$IFNDEF PEAKTOP:OBJ/TIMAGELIST.INC}                          {$I PEAKTOP:OBJ/TIMAGELIST.INC}              {$ENDIF}
{$IFNDEF PEAKTOP:OBJ/TCOLUMNEH.INC}                           {$I PEAKTOP:OBJ/TCOLUMNEH.INC}               {$ENDIF}
{$IFNDEF PEAKTOP:OBJ/TDBGRIDEH.INC}                           {$I PEAKTOP:OBJ/TDBGRIDEH.INC}               {$ENDIF}
{$IFNDEF PEAKTOP:OBJ/TSPLITTER.INC}                           {$I PEAKTOP:OBJ/TSPLITTER.INC}               {$ENDIF}
{$IFNDEF PEAKTOP:OBJ/TXCGRADIENTPANEL.INC}                    {$I PEAKTOP:OBJ/TXCGRADIENTPANEL.INC}        {$ENDIF}
{$IFNDEF PEAKTOP:OBJ/TXCGRADIENTPANELVISTA.INC}               {$I PEAKTOP:OBJ/TXCGRADIENTPANELVISTA.INC}   {$ENDIF}
{$IFNDEF PEAKTOP:OBJ/TXCPANEL.INC}                            {$I PEAKTOP:OBJ/TXCPANEL.INC}                {$ENDIF}
{$IFNDEF PEAKTOP:OBJ/TXCSTDPANEL.INC}                         {$I PEAKTOP:OBJ/TXCSTDPANEL.INC}             {$ENDIF}
{$IFNDEF PEAKTOP:OBJ/TXCTOOLBARBUTTON.INC}                    {$I PEAKTOP:OBJ/TXCTOOLBARBUTTON.INC}        {$ENDIF}
{$IFNDEF PEAKTOP:OBJ/TXFBDATASETS.INC}                        {$I PEAKTOP:OBJ/TXFBDATASETS.INC}            {$ENDIF}
{$IFNDEF PEAKTOP:OBJ/TXFBTREEVIEW.INC}                        {$I PEAKTOP:OBJ/TXFBTREEVIEW.INC}            {$ENDIF}
{$IFNDEF PEAKTOP:OBJ/TXCPAGECONTROLEX.INC}                    {$I PEAKTOP:OBJ/TXCPAGECONTROLEX.INC}        {$ENDIF}
{$IFNDEF PEAKTOP:OBJ/TXCTABSHEET.INC}                         {$I PEAKTOP:OBJ/TXCTABSHEET.INC}             {$ENDIF}
{$IFNDEF PEAKTOP:IDE/ERP/DBO/SHORTCUTS.INC}                   {$I ../SHORTCUTS.INC}                        {$ENDIF}
{$IFNDEF PEAKTOP:IDE/ERP/DBO/OBJECTNAMES.INC}                 {$I ../OBJECTNAMES.INC}                      {$ENDIF}
{$IFNDEF PEAKTOP:IDE/ERP/DBO/DBGRID/COL_PROTOCOL.INC}         {$I ../DBGRID/COL_PROTOCOL.INC}              {$ENDIF}
{$IFNDEF PEAKTOP:IDE/ERP/DBO/DBGRID/ACTIONS.INC}              {$I ../DBGRID/ACTIONS.INC}                   {$ENDIF}
{$IFNDEF PEAKTOP:IDE/ERP/DBO/USERS/GLOBALVARIABLES.INC}       {$I ../USERS/GLOBALVARIABLES.INC}            {$ENDIF}
{$IFNDEF PEAKTOP:IDE/ERP/DBO/$COMMON/FORMERP.INC}             {$I ../$COMMON/FORMERP.INC}                  {$ENDIF}
  //=================== PEAKTOP:IDE/ERP/DBO/DOC/ENUMERATION.PS =================
  procedure ERP_DocEnum_CloseDataSets(aOwner :TComponent);
  begin
    if(TERPForm_TransactionMain(aOwner).InTransaction)then
      begin
      with TERPForm_DataSetMain(aOwner) do
        if Active then
          begin
          if(State <> dsBrowse)then
            try
              Post;
            except
              Cancel;
            end;
          Close;   
          end;
      TERPForm_TransactionMain(aOwner).Commit;
      end;
  end;
  //============================================================================
  procedure ERP_DocEnum_RefreshView(aOwner :TComponent; const aTypeId:string);
  begin
    ERP_DocEnum_CloseDataSets(aOwner);
    with TERPForm_DataSetMain(aOwner) do
      begin
      Prepare;
      ParamByName('TYPE_ID').AsString := aTypeId; 
      try Open; finally end;
      end;
  end;
  //============================================================================
  procedure ERP_DocEnum_FBTreeView_OnClick(Sender :TObject);
  begin
    with TxFBTreeView(Sender) do
      ERP_DocEnum_RefreshView(Owner, GetID);
  end;
  //============================================================================
  procedure ERP_DocEnum_FBTreeView_OnBuildNode(Sender :TObject; StateFieldValue :Variant; var StateImage :Integer);
  begin
    StateImage := 37;
  end;
  //============================================================================
  procedure ERP_DocEnum_DataSetMain_AfterScroll(DataSet :TDataSet);
  begin
    with TxcStdPanel(DataSet.FindComponent(obj_name_erp_paneltop)) do
      begin
      Color      := DataSet.FieldByName('COLOR_BGR').AsInteger;
      Font.Color := DataSet.FieldByName('COLOR_FRG').AsInteger;
      RePaint;
      end;
  end;
  //============================================================================
  procedure ERP_DocEnum_tbbColorFrg_OnClick(Sender :TObject);
  var
    lkClr :TColor;
  begin
    with TDataSet(TComponent(Sender).Owner) do
      begin
      lkClr := FieldByName('COLOR_FRG').AsInteger;
      if not Dialogs.SelectColor(lkClr) then exit;
      if(State <> dsEdit)then Edit;
      FieldByName('COLOR_FRG').AsInteger := lkClr;
      Post;
      end;
    ERP_DocEnum_DataSetMain_AfterScroll(TDataSet(TComponent(Sender).Owner));  
  end;
  //============================================================================
  procedure ERP_DocEnum_tbbColorBgr_OnClick(Sender :TObject);
  var
    lkClr :TColor;
  begin
    with TDataSet(TComponent(Sender).Owner) do
      begin
      lkClr := FieldByName('COLOR_BGR').AsInteger;
      if not Dialogs.SelectColor(lkClr) then exit;
      if(State <> dsEdit)then Edit;
      FieldByName('COLOR_BGR').AsInteger := lkClr;
      Post;
      end;
    ERP_DocEnum_DataSetMain_AfterScroll(TDataSet(TComponent(Sender).Owner));  
  end;
  //============================================================================
  procedure ERP_DocEnum_OnClose(Sender :TObject; var Action :TCloseAction);
  begin
    ERP_DocEnum_CloseDataSets(TComponent(Sender));
    Action := caFree;
  end;
  //============================================================================
  function ERP_DocEnum_Create():TAmunhotepForm;
  var
    lkFBTree      :TxFBTreeView;
    lkSplt        :TSplitter;
    lkFileName    :string;
    lkStrAccss    :string;
    lkPanelClient :TxcPanel;
    lkToolBar     :TxcGradientPanelVista;
    lkTr          :TxFBTransaction;
    lkDTS         :TxFBDataSet;
    lkDTSett      :TxFBDataSet;
    lkDS          :TDataSource;
    lkDSett       :TDataSource;
    lkDBG         :TDBGridEh;
    lkCol         :TColumnEh;
    lkPC                :TxcPageControlEx;
    lkPanelClientTop    :TxcStdPanel;
    lkPanelClientClient :TxcPanel;
    lkPanelClientTopBar :TxcGradientPanelVista;
    lkLBL               :TLabel;
    lkTBB               :TxcToolBarButton;
  begin
    GetField(FBDataBase, 'PROC$_USERS_ACCS('''+ERP_GLOBALVARIABLE_USER_CURRENT+''')', 'ROLES_LIST', '', lkStrAccss);
    Result := TAmunhotepForm(TERPForm_Create('Свойства документов',  ERP_FILENAME_ICO_DOC, ERP_FILENAME_BMP_DOC, false, @ERP_DocEnum_OnClose));
    with Result do
      begin
      end; 
    with TxcGradientPanelVista(Result.FindComponent(obj_name_erp_topbar)) do
      begin
      StyleManager          := nil;
      Colors.HotTrack       := ERP_ObjectColorLight(ERP_OBJECTTYPE_DOC);
      Colors.HotTrackBorder := ERP_ObjectColor(ERP_OBJECTTYPE_DOC);
      end;  
    lkPC := CreateTxcPageControlEx(Result, Result, obj_name_erp_pagecontrol, 0, 48, 200,200,alClient);
    with lkPC do
      begin
      TabStyle := tsSquareCorners;
      end;
    with CreateTxcTabSheet(lkPC,'tsEnum'    ,'Нумераторы  ',379,ERP_ObjectColorLight(ERP_OBJECTTYPE_DOC)) do
      begin
      end;
    with CreateTxcTabSheet(lkPC,'tsSettings','Настройки  ' , 40,ERP_ObjectColorLight(ERP_OBJECTTYPE_OPER)) do
      begin
      end;
    TxcPageControlEx_ActivateDefaultPage(lkPC);  
    CreateTxFBTransDataSet(Result, obj_name_erp_data_trmain, obj_name_erp_data_dtsmain, 'DataSource'+obj_name_erp_data_dtsmain, ['isc_tpb_read_committed', 'isc_tpb_write', 'isc_tpb_rec_version', 'isc_tpb_nowait'], lkTr, lkDTS, lkDS);  
    with lkDTS do
      begin
      SelectSQL.Text  := StringsLoadFromFile(PrepareAbsoleteFileName('PEAKTOP:IDE/ERP/DBO/SQL/OBJECTEDITOR/DOCENUM_SEL.SQL'));
      RefreshSQL.Text := StringsLoadFromFile(PrepareAbsoleteFileName('PEAKTOP:IDE/ERP/DBO/SQL/OBJECTEDITOR/DOCENUM_REF.SQL'));
      ModifySQL.Text  := StringsLoadFromFile(PrepareAbsoleteFileName('PEAKTOP:IDE/ERP/DBO/SQL/OBJECTEDITOR/DOCENUM_UPD.SQL'));
      AfterScroll     := @ERP_DocEnum_DataSetMain_AfterScroll;
      AfterOpen       := @TERPForm_OpenDataSetsChilds;
      BeforeClose     := @TERPForm_CloseDataSetsChilds;
      end;    
    lkDTSett := TxFBDataSet.Create(lkDTS);
    with lkDTSett do
      begin
      Name            := obj_name_erp_data_dtsdata;
      Transaction     := lkDTS.Transaction;
      SelectSQL.Text  := StringsLoadFromFile(PrepareAbsoleteFileName('PEAKTOP:IDE/ERP/DBO/SQL/OBJECTEDITOR/DOCSETT_SEL.SQL'));
      RefreshSQL.Text := StringsLoadFromFile(PrepareAbsoleteFileName('PEAKTOP:IDE/ERP/DBO/SQL/OBJECTEDITOR/DOCSETT_REF.SQL'));
      ModifySQL.Text  := StringsLoadFromFile(PrepareAbsoleteFileName('PEAKTOP:IDE/ERP/DBO/SQL/OBJECTEDITOR/DOCSETT_UPD.SQL'));
      end;
    lkDSett := TDataSource.Create(lkDTSett);
    with lkDSett do
      begin
      Name    := 'DataSource'+lkDTSett.Name;
      DataSet := lkDTSett;
      end; 
    lkFBTree := TxFBTreeView.Create(Result);
    with lkFBTree do
      begin
      Parent    := lkPC.Pages[0];
      Left      := 0;
      Top       := 0;
      Width     := 200;
      Ctl3D     := false;
      Align     := alLeft;
      Color     := Amunhotep.MainForm.StyleManager.Colors.Window;
      Font.Color:= Amunhotep.MainForm.StyleManager.Colors.Border;
      Images    := Amunhotep.MainForm.ImageListMain;
      DataBase  := FBDataBase;
      with DBTreeInfo do
        begin
        TableName     := 'TABL$_TB_TYPES';
        FieldId       := 'ID';
        FieldParentId := 'PARENT_ID';
        FieldStateId  := 'ID';
        FieldName     := 'NAME2';
        RootParentId  := '0';
        Where         := 'ROOT_ID = 4';
        OrderBy       := 'NAME2';
        end;
      ShowOnlyRoots    := false;
      RightClickSelect := true;
      HideSelection    := false;
      OnBuildNode      := @ERP_DocEnum_FBTreeView_OnBuildNode;  
      OnClick          := @ERP_DocEnum_FBTreeView_OnClick;
      BuildTree;
      if(Items.Count > 0)then
        begin
        Items[0].Selected := true;
        end;  
      end;
    lkSplt := TSplitter.Create(Result);
    with lkSplt do
      begin
      Parent := lkPC.Pages[0];
      Left   := lkFBTree.Left + lkFBTree.Width + 4;
      Top    := 0;
      Width  := 4;
      Align  := alLeft;
      Color  := Amunhotep.MainForm.StyleManager.Colors.Foreground;
      end;
    lkPanelClient       := CreateTxcPanel(Result,lkPC.Pages[0],obj_name_erp_panelclient,'',alClient,1,1,600,800,xbsNone); 
    lkPanelClientTop    := CreateTxcStdPanel(lkDTS,lkPanelClient,obj_name_erp_paneltop,'',alTop,1,1,72,800,xbsNone);
    with lkPanelClientTop do
      begin
      Font.Size  := 10;
      Font.Style := [fsBold];
      end;
    lkPanelClientClient := CreateTxcPanel(lkPanelClient,lkPanelClient,obj_name_erp_panelclient,'',alClient,1,1,200,800,xbsNone);
    lkPanelClientTopBar := CreateTxcGradientPanelVista(lkPanelClientTop,lkPanelClientTop,obj_name_erp_topbar,#$20+'отображение документов',alTop, 0,0,20,800,xbsRaized);
    lkPanelClientTopBar.Font.Size := 10;
    lkLBL := CreateTLabel(lkPanelClientTop,lkPanelClientTop, '  Образец строчки документа', 0, lkPanelClientTopBar.Top+lkPanelClientTopBar.Height+1, 24, 200, alTop, taLeftJustify);
    lkTBB := CreateTxcToolBarButton(lkDTS, lkPanelClientTop,'tbbColorFrg','Изменить цвет шрифта', 'Изменить цвет шрифта',4,lkLBL.Top+lkLBL.Height+1,20,200, alNone, 123, nil);
    with lkTBB do
      begin
      ShowHint    := true;
      ShowCaption := true;
      OnClick     := @ERP_DocEnum_tbbColorFrg_OnClick;
      end;
    lkTBB := CreateTxcToolBarButton(lkDTS, lkPanelClientTop,'tbbColorBgr','Изменить цвет фона', 'Изменить цвет фона',lkTBB.Left+lkTBB.Width+4,lkLBL.Top+lkLBL.Height+1,20,200, alNone, 120, nil);
    with lkTBB do
      begin
      ShowHint    := true;
      ShowCaption := true;
      OnClick     := @ERP_DocEnum_tbbColorBgr_OnClick;
      end;
    lkPanelClientTopBar := CreateTxcGradientPanelVista(lkPanelClientClient,lkPanelClientClient,obj_name_erp_topbar,#$20+'нумераторы документов',alTop, 0,0,20,800,xbsRaized);
    lkPanelClientTopBar.Font.Size := 10;
    lkToolBar     := CreateTxcGradientPanelVistaToolBar(Result,lkPanelClientClient,obj_name_erp_toolbar,'',alTop, 0,50,TERPForm_DefaultToolButtonWidth+2, 200,xbsNone);
    lkDBG := CreateTDBGridEh(Result,lkPanelClientClient,lkDS,obj_name_erp_data_dbgmain, 0,100,200,200,alClient);
    with lkDBG do
      begin
      HelpKeyWord := '0';
      with IndicatorTitle do
        begin
        UseGlobalMenu    := true;
        ShowDropDownSign := true;
        TitleButton      := true;
        end;
      Options      := Options   + [dgAlwaysShowSelection];  
      OptionsEh    := OptionsEh + [dghFixed3D, dghFrozen3D, dghFooter3D, dghAutoSortMarking, dghMultiSortMarking,  
        dghIncSearch, dghPreferIncSearch, dghHighlightFocus, dghRowHighlight, dghColumnResize, dghColumnMove, dghExtendVertLines, dghHotTrack];
      EditActions  := [geaSelectAllEh, geaCopyEh];
      SortLocal    := true;
      ShowHint     := true;
      AllowedOperations := [alopUpdateEh];
      VTitleMargin := 4;
      Columns.Clear;
      end; 
    lkCol := CreateTColumnEh(lkDBG,'NAME'      ,''             ,'Фирма учета',240,taLeftJustify ); 
    with lkCol do
      begin
      Color    := lkDBG.FixedColor;
      ReadOnly := true;
      end;  
    lkCol := CreateTColumnEh(lkDBG,'GENR_NAME' ,''             ,'Нумератор'  ,240,taLeftJustify );  
    with lkCol do
      begin
      Color    := lkDBG.FixedColor;
      ReadOnly := true;
      end;  
    lkCol := CreateTColumnEh(lkDBG,'GENR_VALUE','# ### ### ##0','Значение'   , 80,taRightJustify); 
      lkCol.ReadOnly := not( (Pos('~1000000~', lkStrAccss) > 0) or (GetGlobalVariable(ERP_GLOBALVARIABLE_USER_CURRENT) = 'PEAKTOP') );
    lkDBG.FrozenCols := 2;   
    ERP_DBGridEh_StdActions_Create(lkDBG, [erpGrid,erpGridNavigation, erpGridExport], lkToolBar, nil);
    lkLBL := CreateTLabel(lkDBG.Parent,lkDBG.Parent,'', 0, lkDBG.Top+lkDBG.Height+1, 60, 200, alBottom, taLeftJustify);
    with lkLBL do
      begin
      Transparent := false;
      Color       := Amunhotep.MainForm.StyleManager.Colors.Window;
      Font.Color  := Amunhotep.MainForm.StyleManager.Colors.Error;
      Font.Size   := 8;
      Font.Style  := [fsBold];
      Caption     := StringsLoadFromFile(StrAbsolutePath('./ENUMERATION_HELP.TXT', ScriptName));
      end;

    lkDBG := CreateTDBGridEh(Result,lkPC.Pages[1],lkDSett,obj_name_erp_data_dbgdata, 0,100,200,200,alClient);
    with lkDBG do
      begin
      Font.Size := 10;
      HelpKeyWord := '0';
      with IndicatorTitle do
        begin
        UseGlobalMenu    := true;
        ShowDropDownSign := true;
        TitleButton      := true;
        end;
      Options      := Options   + [dgAlwaysShowSelection];  
      OptionsEh    := OptionsEh + [dghFixed3D, dghFrozen3D, dghFooter3D, dghAutoSortMarking, dghMultiSortMarking,  
        dghIncSearch, dghPreferIncSearch, dghHighlightFocus, dghRowHighlight, dghColumnResize, dghColumnMove, dghExtendVertLines, dghHotTrack];
      EditActions  := [geaSelectAllEh, geaCopyEh];
      SortLocal    := true;
      ShowHint     := true;
      AllowedOperations := [alopUpdateEh];
      VTitleMargin := 16;
      Columns.Clear;
      end; 
    {
    lkCol := CreateTColumnEh(lkDBG,'GENR_NAME' ,'','Нумератор'  ,240,taLeftJustify );  
    with lkCol do
      begin
      Color    := lkDBG.FixedColor;
      ReadOnly := true;
      end;  
    }
    lkCol := CreateTColumnEh(lkDBG,'GENR_DESCR','','Название настройки',420,taLeftJustify );  
    with lkCol do
      begin
      Color    := lkDBG.FixedColor;
      ReadOnly := true;
      end;  
    lkCol := CreateTColumnEh(lkDBG,'GENR_VALUE','','Значение'   , 56,taLeftJustify); 
    with lkCol do
      begin
      KeyList.Clear;  KeyList.Add('1')  ; KeyList.Add('0');
      PickList.Clear; PickList.Add('Да'); PickList.Add('Нет');
      AlwaysShowEditButton := true;
      end;
      lkCol.ReadOnly := not( (Pos('~1000000~', lkStrAccss) > 0) or (GetGlobalVariable(ERP_GLOBALVARIABLE_USER_CURRENT) = 'PEAKTOP') );
    ERP_DocEnum_FBTreeView_OnClick(lkFBTree);
  end;

begin
  ExecSQL(FBDataBase, StringsLoadFromFile('PEAKTOP:IDE/ERP/DBO/SQL/OBJECTEDITOR/DOCENUM_CHECK.SQL') );

  ERP_DocEnum_Create();
end.
