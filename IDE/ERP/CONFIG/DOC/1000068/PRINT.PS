{$I PEAKTOP:GLOBAL_VARIABLES.INC}
{$IFNDEF PEAKTOP:IDE/FIREBIRD/DIALOGS/CUSTOM.INC}
  {$I PEAKTOP:IDE/FIREBIRD/DIALOGS/CUSTOM.INC}
{$ENDIF}
  //==========================================================================
  function DlgPrint_Execute(const aCaption, aItems:string; var aIndex, aTMCGroupId :Integer):Boolean;
  var
    lkForm        :TForm;
    lkImg         :TImage;
    lkPanelClient :TxcGradientPanel;
    lkCxTmcGroupAll:TxcCheckBox;
    lkLabel       :TLabel;
    lkCbxTmcGroup :TComboBox;
    lkCbxItems    :TComboBox;
    lkStr         :string;
  begin
    Result := false;
    lkForm        := FirebirdDialog_Create(aCaption,'Просмотр', 'Отмена');
    lkForm.Height := 260;
    lkForm.Width  := 420;
    lkPanelClient := TxcGradientPanel(lkForm.FindComponent('PanelClient'));
    lkImg         := TImage(lkForm.FindComponent('ImageLogo'));
    lkImg.Visible := false;
    lkImg.Width   := 0;
    lkCxTmcGroupAll := TxcCheckBox.Create(lkForm);
    with lkCxTmcGroupAll do
      begin
      Parent      := lkPanelClient;
      Left        := lkImg.Left + lkImg.Width;
      Top         := 8;
      Width       := lkForm.Width - (lkImg.Left + lkImg.Width + 4);
      Height      := 20; 
      Caption     := 'Включить в отчет все предметы залога';
      Font.Name   := 'Verdana';
      Font.Size   := DefaultFirebirdDialogLabelFontHeight;
      Font.Style  := [fsBold];
      StyleManager:= Amunhotep.MainForm.StyleManager;
      Checked     := true;
      end;
    lkLabel := TLabel.Create(lkForm);
    with lkLabel do
      begin
      Parent      := lkPanelClient;
      Left        := lkImg.Left + lkImg.Width;
      Top         := lkCxTmcGroupAll.Top + lkCxTmcGroupAll.Height + 4;
      Width       := lkForm.Width - (lkImg.Left + lkImg.Width + 4);
      Height      := 20; 
      Transparent := true;
      Caption     := 'Выберите вид предметов залога';
      Font.Name   := 'Verdana';
      Font.Size   := DefaultFirebirdDialogLabelFontHeight;
      Font.Style  := [fsBold];
      end;
    lkCbxTmcGroup := TComboBox.Create(lkForm);
    with lkCbxTmcGroup do
      begin
      Parent     := lkPanelClient;
      Ctl3d      := false;
      Color      := Amunhotep.MainForm.StyleManager.Colors.Window;
      Font.Color := Amunhotep.MainForm.StyleManager.Colors.Border;
      Font.Style := [fsBold];
      Font.Name  := 'Verdana';
      Font.Size  := DefaultFirebirdDialogEditFontHeight;
      Left       := lkImg.Left + lkImg.Width + 8;
      Width      := lkForm.Width - (lkImg.Left + lkImg.Width + 16);
      Top        := lkLabel.Top + lkLabel.Height + 4; 
      Items.Text := '';
      if GetField(FBdataBase, 'TABL$R_TMC_GROUP', 'ID||''.  ''||NAME', 'PARENT_ID = 150000', lkStr)then
        Items.Text := lkStr;
      ItemIndex  := 0;
      Style      := csDropDownList;
      end;
    lkLabel := TLabel.Create(lkForm);
    with lkLabel do
      begin
      Parent      := lkPanelClient;
      Left        := lkImg.Left + lkImg.Width;
      Top         := lkCbxTmcGroup.Top + lkCbxTmcGroup.Height + 4;
      Width       := lkForm.Width - (lkImg.Left + lkImg.Width + 4);
      Height      := 20; 
      Transparent := true;
      Caption     := 'Выберите шаблон печати';
      Font.Name   := 'Verdana';
      Font.Size   := DefaultFirebirdDialogLabelFontHeight;
      Font.Style  := [fsBold];
      end;
    lkCbxItems := TComboBox.Create(lkForm);
    with lkCbxItems do
      begin
      Parent     := lkPanelClient;
      Ctl3d      := false;
      Color      := Amunhotep.MainForm.StyleManager.Colors.Window;
      Font.Color := Amunhotep.MainForm.StyleManager.Colors.Border;
      Font.Style := [fsBold];
      Font.Name  := 'Verdana';
      Font.Size  := DefaultFirebirdDialogEditFontHeight;
      Left       := lkImg.Left + lkImg.Width + 8;
      Width      := lkForm.Width - (lkImg.Left + lkImg.Width + 16);
      Top        := lkLabel.Top + lkLabel.Height + 4; 
      Items.Text := aItems;
      ItemIndex  := 0;
      Style      := csDropDownList;
      end;
    Result := (lkForm.ShowModal = mrOk);
    if Result then
      begin
      aIndex := lkCbxItems.ItemIndex;
      if lkCxTmcGroupAll.Checked then
        aTMCGroupId := 0
       else  
        aTMCGroupId := StrToInt(StrCiphersOnlyInt(Copy(lkCbxTmcGroup.Items[lkCbxTmcGroup.ItemIndex], 1, Pos('.  ',lkCbxTmcGroup.Items[lkCbxTmcGroup.ItemIndex]))));
      end;
    lkForm.Free;
  end;
  //==========================================================================
  function PreviewReport(const ID, ResName, Title:string; const aTMCGroupId:Integer; const aSummary:Boolean; 
             const aGrouppByCSINN:Boolean):Boolean;
  var
    lkRpt :TxReport;
    lkRes :string;
    lkImg :TxrImage;
    lkSQL :string;
  begin
    Result := false;
    lkRes := StringsLoadFromFile(ResName);
    if(StrTrimAll(lkRes) = '')then
      begin
      Dialogs.MessageDlg('Неверный файл ресурсов '+#13#10+ResName, mtError, [mbOk]);
      exit;
      end;
    lkRpt := TxReport(StrToComponent(lkRes));  
    lkRpt.Title    := Title+' '+ID;
    lkRpt.DataBase := FBDataBase;
    if(lkRpt.DataSets.Count < 3)then
      while(lkRpt.DataSets.Count < 3)do
        lkRpt.DataSets.Add;
    if aSummary then
      lkSQL := 'SELECT PC.* FROM PROC$D_GET_1000068_SUM('''+ID+''') PC '
     else  
      begin
      if aGrouppByCSINN then
        lkSQL := 
          'SELECT PC.JZ_CS_INN, PC.JZ_CS_NAME, LIST(PC.JZ_NUMBER,'','') AS JZ_NUMBER, SUM(PC.JZ_DOCSUMLEFT) AS JZ_DOCSUMLEFT, SUM(PC.TOTAL) AS TOTAL '+
          'FROM   PROC$D_GET_1000068('''+ID+''') PC '+
          'GROUP BY PC.JZ_CS_INN, PC.JZ_CS_NAME '
       else  
        lkSQL := 'SELECT PC.* FROM PROC$D_GET_1000068('''+ID+''') PC ';
      end
    if( (aTMCGroupId <> 0) and (not aSummary) and (not aGrouppByCSINN) )then
      lkSQL := lkSQL + ' WHERE (PC.TMC_GROUP_ID = '+IntToStr(aTMCGroupId)+') ';  
//    if not aGrouppByCSINN then
//      lkSQL := lkSQL + ' ORDER BY PC.TMC_COUNTRY_NAME, PC.TMC_PROBE ';  
    lkRpt.DataSets[0].SQL.Text := lkSQL;
    lkRpt.DataSets[0].Name     := 'qrMain';
    lkRpt.DataSets[1].SQL.Text := 'SELECT P1.* FROM PROC$D_1000068('''+ID+''') P1 ';
    lkRpt.DataSets[1].Name     := 'qrDoc';
    lkRpt.DataSets[2].SQL.Text := 'SELECT P2.* FROM PROC$D_ENT_CONST('''+ID+''') P2 ';
    lkRpt.DataSets[2].Name     := 'qrEnt';
    lkImg := TxrImage(lkRpt.FindComponent('ImgLogo'));
    lkRes := StrAbsolutePath('../conf/ent/logo.bmp', Amunhotep.ExeName);
    if FileExists(lkRes)then
      try
        lkImg.Picture.LoadFromFile(lkRes);
      except
      end;
    lkRpt.Prepare;
    lkRpt.Preview;
  end;
  //==========================================================================
var
  J_ID      :string;
  J_TYPE_ID :string;
  SLNames   :TStringList;
  SLFiles   :TStringList;
  Indx, TMCGroupId :Integer;begin
  J_ID := GetGlobalVariable('J_ID');
  if((StrTrimAll(J_ID)='')or(UpperCase(J_ID)='NULL'))then exit;
  if GetField(FBDataBase, 'TABL$J_4', 'TYPE_ID', 'ID = '''+J_ID+''' ', J_TYPE_ID)then
    begin
    SLNames := TStringList.Create; SLFiles := TStringList.Create;
    SLNames.Clear;                 SLFiles.Clear;
    SLNames.Add('Акт выставления на реализацию');                       SLFiles.Add('./RPT_ACT.XFM');       // done 0
    SLNames.Add('Ведомость отправленных ценностей');                    SLFiles.Add('./RPT_VED.XFM');       // done 1
    SLNames.Add('Описание отправленных ценностей');                     SLFiles.Add('./RPT_DESCRFULL.XFM'); // done 2
    SLNames.Add('Описание по пробам и ценам');                          SLFiles.Add('./RPT_DESCR.XFM');     // done 3
    SLNames.Add('Регистр вложения');                                    SLFiles.Add('./RPT_REG.XFM');       // done 4
    SLNames.Add('Ярлыки для пакетов');                                  SLFiles.Add('./RPT_LINKS.XFM');     // done 5
    SLNames.Add('Ярлыки для изделий');                                  SLFiles.Add('./RPT_LINKSFULL.XFM'); // done 6
    SLNames.Add('Налоговый расчет (без группировки)');                  SLFiles.Add('./RPT_NR.XFM');        // done 7
    SLNames.Add('Налоговый расчет (с группировкой)');                   SLFiles.Add('./RPT_NR.XFM');        // done 8
    SLNames.Add('+Счет');                                               SLFiles.Add('./RPT_SCHET.XFM');     // done 9
    SLNames.Add('+Расходная накладная (на лом металла)');               SLFiles.Add('./RPT_RN.XFM');        // done 10
    SLNames.Add('+Расходная накладная (товарная)');                     SLFiles.Add('./RPT_RN2.XFM');       // done 11
//    SLNames.Add('Регистр отправки');                    SLFiles.Add('./RPT_REG_SEND.XFM');
//    SLNames.Add('Товарная накладная');                  SLFiles.Add('./RPT_BILL.XFM');
    if DlgPrint_Execute('Выберите шаблон печати', SLNames.Text, Indx, TMCGroupId)then
      PreviewReport(J_ID, StrAbsolutePath(SLFiles[Indx], ScriptName), SLNames[Indx], TMCGroupId, 
        ((Indx > 2) and (Indx < 6)) or ((Indx >= 9) and (Indx <= 10)), (Indx=8)  );
    SLNames.Free; SLFiles.Free;
    end;  
end.
